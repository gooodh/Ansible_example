#SPDX-License-Identifier: MIT-0
---
- name: Ensure project directory exists
  file:
    path: "{{ project_path }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Clone project from Git
  git:
    repo: "{{ project_repo }}"
    dest: "{{ project_path }}"
    version: "main"  # или другая ветка/тег
    force: yes

- name: Copy .env file to project root
  copy:
    src: ".env"
    dest: "{{ project_path }}/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Install Python venv if missing
  apt:
    name: python{{ python_version }}-venv
    state: present
  become: true

- name: Create virtual environment
  command: python{{ python_version }} -m venv "{{ project_path }}/venv"
  args:
    creates: "{{ project_path }}/venv/bin/activate"

- name: Install Python dependencies
  pip:
    requirements: "{{ project_path }}/requirements.txt"
    virtualenv: "{{ project_path }}/venv"
    virtualenv_python: "python{{ python_version }}"

- name: Install systemd service for app
  template:
    src: python_app.service.j2
    dest: /etc/systemd/system/python_app.service
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: true

- name: Enable and start app service
  systemd:
    name: python_app.service
    enabled: yes
    state: started
  become: true

